# Repository Guidelines

## Core Architecture Principle: Agentic UI Generation

**n.codes MUST NOT use pre-defined templates or component types.** Agentic UI means the AI generates the complete UI (HTML/CSS/JS) from scratch based on the user's prompt. We cannot predict what the user will ask for, so the system must be capable of generating any UI on the fly.

The correct architecture is an agentic loop:
1. **Understand** — Parse the user's intent; ask clarifying questions if ambiguous
2. **Generate** — Produce the full UI code (not a DSL mapped to fixed component renderers)
3. **Connect** — Wire the generated UI to real APIs using the capability map
4. **QA** — A review agent evaluates the generated view and provides feedback
5. **Iterate** — The generation agent incorporates feedback and re-generates until satisfactory

The capability map (generated by `n.codes sync`) remains the contract between generated UI and the host app's APIs. But the UI itself must be generated code, not template instantiation.

## Project Structure & Module Organization
- `public/` contains the production landing page and static assets. Key files include `public/index.html` (landing page) and SEO assets like `public/og.html`, `public/robots.txt`, and icons.
- `public/demo/` holds the interactive demo (`public/demo/index.html`, `public/demo/styles.css`, `public/demo/app.js`).
- `cli/` contains the n.codes CLI tool for capability map generation and installation.
- `widget/` contains the n.codes widget SDK (`@ncodes/widget`) — an installable package that adds the AI prompt UI to any web app.
- `test-projects/` contains 5 small framework-specific apps for testing the widget installation flow.
- `docs/plans/` includes architecture or planning docs such as `docs/plans/llm-capability-analysis.md`.
- `README.md` explains the product context; `draft.md` is scratch space.

## CLI Module Organization (`cli/lib/`)

Core modules:
- `capability-map.js` — Capability map data structures, YAML serialization, heuristic inference
- `sync.js` — Full capability map generation (`n.codes sync`)
- `dev.js` — Watch mode with incremental updates (`n.codes dev`)
- `introspect.js` — File collection and indexing
- `config.js` — Configuration loading/saving (`n.codes.config.json`)
- `init.js` — Interactive setup (`n.codes init`)
- `cache.js` — File index and analysis result caching
- `validate.js` — Capability map validation (`n.codes validate`)

Installation modules:
- `install.js` — Generate LLM-friendly installation instructions (`n.codes install`)
- `detect-framework.js` — Auto-detect project framework from file structure and dependencies
- `templates/*.md` — Per-framework installation instruction templates (Next.js, Express, Vue, SvelteKit, generic)

LLM analysis modules (see `docs/plans/llm-capability-analysis.md`):
- `llm.js` — Vercel AI SDK wrapper, provider config, retry logic, concurrency control
- `imports.js` — Parse and resolve immediate imports from route files
- `analyzer.js` — Build prompts, parse LLM responses, extract and merge entities

Supported LLM providers:
- **OpenAI:** `gpt-5-mini`, `gpt-5.2`
- **Claude:** `claude-sonnet-4-5`, `claude-opus-4-5`, `claude-haiku-4-5`

## Build, Test, and Development Commands

Landing page:
- `npm install -g live-server` — install the local static server used for development.
- `live-server` (run from `public/`) — serve the landing page with live reload at `http://127.0.0.1:8080`.
- `live-server public/demo` — serve the demo page directly when iterating on demo-only changes.

CLI:
- `npm install` — install dependencies (including Vercel AI SDK for LLM analysis).
- `node cli/index.js init` — initialize config with provider/model selection.
- `node cli/index.js sync` — generate full capability map with LLM analysis (outputs YAML + JSON).
- `node cli/index.js sync --force` — regenerate all routes, ignoring cache.
- `node cli/index.js dev` — watch mode with incremental analysis.
- `node cli/index.js validate` — validate capability map structure.
- `node cli/index.js install` — generate LLM-friendly installation instructions at `.n.codes/INSTALL.md`.

Widget SDK:
- `cd widget && npm install` — install widget build dependencies.
- `cd widget && npm run build` — build UMD + ESM bundles to `widget/dist/`.
- `cd widget && npm test` — run widget unit tests.

Integration tests:
- `node scripts/test-installation-flow.js` — test install flow across all 5 test projects.

## Coding Style & Naming Conventions
- Indentation: 2 spaces in HTML/CSS/JS, as used across `public/index.html` and `public/demo/app.js`.
- JavaScript: vanilla, no build step; prefer `const`/`let`, semicolons, and small, named helper functions.
- HTML/CSS: class and id names use kebab-case (e.g., `ncodes-panel`, `quick-prompt`).
- Keep inline CSS in `public/index.html` aligned with the existing variable-driven theme (`:root` tokens).

## Testing Guidelines
- Automated tests: `node --test cli/tests/*.test.js`.
- Coverage gate: `npm run coverage` must stay at or above 80% for lines, functions, branches, and statements.
- AI agents: always run `npm run coverage` before finishing work and confirm the coverage thresholds pass.
- Smoke checks: open `public/index.html` and `public/demo/index.html`, verify layout, interactions, and responsive behavior.
- **Mobile testing**: Always test responsive behavior at 600px breakpoint. Use browser dev tools device emulation.

## Landing Page Guidelines
See `public/AGENTS.md` for detailed landing page and mobile-specific patterns.

## Commit & Pull Request Guidelines
- Commit messages are short and imperative (e.g., “Add interactive demo”, “Fix wording for clarity”).
- Optional scope prefixes like `docs:` are acceptable when changes are documentation-only.
- PRs should include: a clear description, linked issue (if any), and screenshots or a short recording for UI changes.

## Security & Configuration Tips
- This is a static site; avoid adding runtime secrets to the repo.
- Prefer local testing with `live-server` instead of adding new build tooling unless necessary.
- Capability map generation uses LLM analysis for semantic understanding. Configuration:
  - Provider/model stored in `n.codes.config.json`
  - API keys stored in `.env.local` (not `.env`) — keep out of version control
  - Environment variables: `OPENAI_API_KEY` or `ANTHROPIC_API_KEY`
- If LLM analysis fails, the system falls back to heuristic descriptions marked with `analysisSource: "heuristic"`.
